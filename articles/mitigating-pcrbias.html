<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Example of using Fido for measuring and mitigating PCR Bias • fido</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Example of using Fido for measuring and mitigating PCR Bias">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fido</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/introduction-to-fido.html">Introduction to fido::Pibble</a></li>
    <li><a class="dropdown-item" href="../articles/non-linear-models.html">Non-linear models with fido::basset</a></li>
    <li><a class="dropdown-item" href="../articles/orthus.html">Joint Modeling  (e.g., Multiomics) with fido::Orthus</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jsilve24/fido/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Example of using Fido for measuring and mitigating PCR Bias</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jsilve24/fido/blob/master/vignettes/mitigating-pcrbias.Rmd" class="external-link"><code>vignettes/mitigating-pcrbias.Rmd</code></a></small>
      <div class="d-none name"><code>mitigating-pcrbias.Rmd</code></div>
    </div>

    
    
<p>If you have no already done so, I would read through our manuscript
<a href="https://www.biorxiv.org/content/10.1101/604025v1" class="external-link">Measuring and
Mitigating PCR Bias in Microbiome Data</a>. This vignette only discusses
the computational aspect of our approach, equally important is the
design of the PCR calibration curve which is detailed in the
manuscript.</p>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>PCR bias can be both measured and corrected by combining a specially
designed calibration curve with statistical models. The below figure
gives a brief overview of the calibration experiment. In brief, samples
are pooled to create a “calibration sample”. This calibration sample
then contains DNA from every taxa in your study. The calibration sample
is then split into multiple aliquots and amplified for a varying number
of cycles. You then sequence the resulting samples along with the
original samples. Then you turn to modeling (which is the focus of this
vignette).</p>
<p><img src="https://github.com/jsilve24/fido/raw/master/vignettes/pcrbias_summary_graphic.png" width="50%" style="display: block; margin: auto;"></p>
<p>In the manuscript, we show that PCR bias is well approximated by a
simple multiplicative process. When translated to sequence count data,
this means that PCR bias represents a linear process in log-ratio space:
We just need multinomial logistic-normal linear models (aka
<code>pibble</code> models in the <em>fido</em> package). If we set our
model up correctly then PCR bias is just a linear model: There is a bias
parameter and the amount of bias seen for a given sample is that
parameter times the number of PCR cycles that sample underwent prior to
sequencing. In this case our estimate for the unbiased composition of
each sample just becomes a unique intercept for each sample (if you have
technical / biological replicates then the replicates will share an
intercept; we demonstrate that below as well). Another way to think
about this is we want to estimate the composition when the number of PCR
cycles is equal to zero (aka the intercept).</p>
</div>
<div class="section level2">
<h2 id="an-example">An Example<a class="anchor" aria-label="anchor" href="#an-example"></a>
</h2>
<p>Here I will show an example of how such data (including calibration
samples can be modeled). This is the mock community data we analyzed in
the manuscript.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jsilve24.github.io/fido/">fido</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">5903</span><span class="op">)</span></span>
<span><span class="co"># First load the data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">pcrbias_mock</span><span class="op">)</span></span></code></pre></div>
<p>Lets first take a brief look at the data. There are two objects
<code>Y</code> (a count table that I already preprocessed just as in our
manuscript) and <code>metadata</code> which contains the covariates we
need (including the number of PCR cycles each sample has undergone).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Y</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt;               cycle13.1 cycle13.2 cycle13.3 cycle14.1 cycle14.2</span></span>
<span><span class="co">#&gt; B.longum             27        28        22        37        44</span></span>
<span><span class="co">#&gt; B.subtilis          320       299       272       513       650</span></span>
<span><span class="co">#&gt; C.aerofaciens        35        32        39        43        84</span></span>
<span><span class="co">#&gt; C.hathewayi          61        52        59        93       117</span></span>
<span><span class="co">#&gt; C.innocuum          121        91       112       197       208</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span></span>
<span><span class="co">#&gt;   sample_name  sample_num cycle_num machine</span></span>
<span><span class="co">#&gt; 1   cycle13.1 Calibration        13       3</span></span>
<span><span class="co">#&gt; 2   cycle13.2 Calibration        13       3</span></span>
<span><span class="co">#&gt; 3   cycle13.3 Calibration        13       3</span></span>
<span><span class="co">#&gt; 4   cycle14.1 Calibration        14       4</span></span>
<span><span class="co">#&gt; 5   cycle14.2 Calibration        14       4</span></span>
<span><span class="co">#&gt; 6   cycle14.3 Calibration        14       4</span></span></code></pre></div>
<p>The only non-obvious variable here is probably <code>machine</code>
which just is a categorical variable denoting which of 4 different PCR
machines used to amplify a given sample. When writing the paper, we
thought this might be a source of bias so we included this as a term in
our model (we will do the same here just to demonstrate how).</p>
<p>As <em>fido</em> doesn’t yet have a formula interface (I will write
that eventually), you just need to use the formula interface provided by
base-R’s <code>model.matrix</code> function.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">cycle_num</span> <span class="op">+</span> <span class="va">sample_num</span> <span class="op">+</span> <span class="va">machine</span>  <span class="op">-</span><span class="fl">1</span>, data <span class="op">=</span> <span class="va">metadata</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt;                        1  2  3  4  5</span></span>
<span><span class="co">#&gt; cycle_num             13 13 13 14 14</span></span>
<span><span class="co">#&gt; sample_numCalibration  1  1  1  1  1</span></span>
<span><span class="co">#&gt; sample_numMock1        0  0  0  0  0</span></span>
<span><span class="co">#&gt; sample_numMock10       0  0  0  0  0</span></span>
<span><span class="co">#&gt; sample_numMock2        0  0  0  0  0</span></span>
<span><span class="co">#&gt; sample_numMock3        0  0  0  0  0</span></span>
<span><span class="co">#&gt; sample_numMock4        0  0  0  0  0</span></span>
<span><span class="co">#&gt; sample_numMock5        0  0  0  0  0</span></span>
<span><span class="co">#&gt; sample_numMock6        0  0  0  0  0</span></span>
<span><span class="co">#&gt; sample_numMock7        0  0  0  0  0</span></span>
<span><span class="co">#&gt; sample_numMock8        0  0  0  0  0</span></span>
<span><span class="co">#&gt; sample_numMock9        0  0  0  0  0</span></span>
<span><span class="co">#&gt; machine2               0  0  0  0  0</span></span>
<span><span class="co">#&gt; machine3               1  1  1  0  0</span></span>
<span><span class="co">#&gt; machine4               0  0  0  1  1</span></span></code></pre></div>
<p>You can see that in doing this we have created a design matrix which
has encoded the PCR machine using a series of 3 dummy variables. We also
have a series of dummy variables denoting which samples are biologically
unique (e.g., <code>sample_num</code>). The <code>-1</code> in the
formula just tells R to have a unique intercept for each biological
sample (e.g., to use a one-hot-encoding rather than the dummy encoding
used for the PCR machines).</p>
<p>Next we are going to specify our model priors and fit the model. A
detailed description of the general thought process I like to follow
when creating priors in <em>fido</em> is provided in the vignette
<em>Tips for Specifying Priors</em>. Here I am just going to a simple
prior where I just change <code>Gamma</code> from its default values. If
you are wondering, in the manuscript I choose the multiplier 10 based on
maximum marginal likelihood. At the end of this vignette I will show an
example of how this can be done.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pibble_fit.html">pibble</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Y</span>, X<span class="op">=</span><span class="va">X</span>, Gamma <span class="op">=</span> <span class="fl">10</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next we are going to transform the results into CLR coordinates and
interpret them in that space.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fido_transforms.html">to_clr</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<p>That’s about it. Now its just interpreting the model results. Lets
say you want to investigate the estimated unbiased composition, then you
just have to look at the inferred random intercepts for the
corresponding <code>sample_num</code> variable. We can plot the results
simply enough:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># pull out indices for random intercepts corresponding to `sample_num`</span></span>
<span><span class="va">focus.covariate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"sample_num"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Also just so the plot fits nicely in Rmarkdown we are also going to just </span></span>
<span><span class="co"># plot a few of the taxa</span></span>
<span><span class="va">focus.coord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"clr_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S.gallolyticus"</span>, <span class="st">"R.intestinalis"</span>, <span class="st">"L.ruminis"</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Also to make the plot fit nicely, I just flip the orientation of the plot </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit</span>, par<span class="op">=</span><span class="st">"Lambda"</span>, focus.cov<span class="op">=</span><span class="va">focus.covariate</span>, focus.coord<span class="op">=</span><span class="va">focus.coord</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>strip.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle<span class="op">=</span><span class="fl">0</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">covariate</span><span class="op">~</span><span class="va">.</span><span class="op">)</span></span>
<span><span class="co">#&gt; Scale for 'colour' is already present. Adding another scale for 'colour', which will</span></span>
<span><span class="co">#&gt; replace the existing scale.</span></span></code></pre></div>
<p><img src="https://github.com/jsilve24/fido/raw/master/vignettes/pcr-model-results.png" width="50%" style="display: block; margin: auto;"></p>
<p>The compositional bias introduced at each cycle can also be
visualized.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Also to make the plot fit nicely, I just flip the orientation of the plot </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit</span>, par<span class="op">=</span><span class="st">"Lambda"</span>, focus.cov<span class="op">=</span><span class="st">"cycle_num"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Scale for 'colour' is already present. Adding another scale for 'colour', which will</span></span>
<span><span class="co">#&gt; replace the existing scale.</span></span></code></pre></div>
<p><img src="https://github.com/jsilve24/fido/raw/master/vignettes/pcr-results-cycle-num.png" width="50%" style="display: block; margin: auto;"></p>
<p>The <em>fido</em> package has a bunch of tools for working with such
fitted models depending on what you ultimately want to do. See the main
<code>pibble</code> vignette for a fuller description of what you can do
with such fitted models.</p>
<p>One plot I find particularly useful, is visualizing the calibration
data and the fitted bias model. This can be done as follows:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># First transform the data into CLR coordinates (requires pseudo-count to deal with</span></span>
<span><span class="co"># zeros). Then will convert to tidy format for ggplot </span></span>
<span><span class="va">tidy_calibration</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clr_array.html">clr_array</a></span><span class="op">(</span><span class="va">Y</span><span class="op">+</span><span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># transform to CLR</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"cycle"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  <span class="co"># select only samples from the calibration</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">tidy_calibration</span><span class="op">$</span><span class="va">sample_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">tidy_calibration</span><span class="op">)</span></span>
<span><span class="va">tidy_calibration</span> <span class="op">&lt;-</span> <span class="va">tidy_calibration</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="va">coord</span>, <span class="va">val</span>, <span class="op">-</span><span class="va">sample_name</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>coord <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">coord</span>, <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">metadata</span>, by<span class="op">=</span><span class="st">"sample_name"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>coord <span class="op">=</span> <span class="fu"><a href="../reference/name_dims.html">names_coords</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">[</span><span class="va">coord</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span></span>
<span><span class="co"># Now the important part - lets grab the pibble result of interest</span></span>
<span><span class="va">X.tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span> <span class="co"># Create fake covariate data to predict the regression line based on </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">X.tmp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">X.tmp</span><span class="op">[</span><span class="st">"cycle_num"</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">35</span></span>
<span><span class="va">X.tmp</span><span class="op">[</span><span class="st">"sample_numCalibration"</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">X.tmp</span> <span class="co"># simple, just going to predict the composition for each of these two samples</span></span>
<span><span class="co">#&gt;                       [,1] [,2]</span></span>
<span><span class="co">#&gt; cycle_num                0   35</span></span>
<span><span class="co">#&gt; sample_numCalibration    1    1</span></span>
<span><span class="co">#&gt; sample_numMock1          0    0</span></span>
<span><span class="co">#&gt; sample_numMock10         0    0</span></span>
<span><span class="co">#&gt; sample_numMock2          0    0</span></span>
<span><span class="co">#&gt; sample_numMock3          0    0</span></span>
<span><span class="co">#&gt; sample_numMock4          0    0</span></span>
<span><span class="co">#&gt; sample_numMock5          0    0</span></span>
<span><span class="co">#&gt; sample_numMock6          0    0</span></span>
<span><span class="co">#&gt; sample_numMock7          0    0</span></span>
<span><span class="co">#&gt; sample_numMock8          0    0</span></span>
<span><span class="co">#&gt; sample_numMock9          0    0</span></span>
<span><span class="co">#&gt; machine2                 0    0</span></span>
<span><span class="co">#&gt; machine3                 0    0</span></span>
<span><span class="co">#&gt; machine4                 0    0</span></span>
<span>      <span class="co"># for the plot</span></span>
<span></span>
<span><span class="co"># Now predict the fitted regression line for cycle_num using X.tmp</span></span>
<span><span class="va">predicted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, newdata<span class="op">=</span><span class="va">X.tmp</span>, summary<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cycle_num <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">35</span><span class="op">)</span><span class="op">[</span><span class="va">sample</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># now plot </span></span>
<span><span class="va">predicted</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">cycle_num</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">p2.5</span>, ymax<span class="op">=</span><span class="va">p97.5</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"darkgrey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">tidy_calibration</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">val</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">coord</span><span class="op">~</span><span class="va">.</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>strip.text.y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"CLR Coordinates"</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://github.com/jsilve24/fido/raw/master/vignettes/pcr-clr-cycle-num.png" width="50%" style="display: block; margin: auto;"></p>
<p>There are two things I look for in these plots. First, the data
should look linear in this space. If the data does not look linear then
there are a few options: (a) something went wrong in your calibration
experiment, (b) something is wrong with your code for plotting the
calibration data, (c) our theory and prior experiments are wrong and PCR
bias is not well approximated as log-ratio linear. Second, you should
look to make sure your model is doing a good job fitting the data. Just
remember the data here has a<br>
few other sources of variation that the model is accounting for but not
plotting. For example, there is batch variation (think about the PCR
machine variable we included above). There are also zeros; here we just
add a pseudo-count and transform the data, internally <em>fido</em> is
actually modeling the zeros which should be more appropriate than the
pseudo-count.</p>
</div>
<div class="section level2">
<h2 id="using-maximum-marginal-likelihood-to-estimate-a-scale-of-gamma">Using Maximum Marginal Likelihood to estimate a scale of Gamma<a class="anchor" aria-label="anchor" href="#using-maximum-marginal-likelihood-to-estimate-a-scale-of-gamma"></a>
</h2>
<p>Above I chose my prior for gamma to be a diagonal matrix multiplied
by a factor of 10. How did I choose 10? In the manuscript I used
something called maximum marginal likelihood. Essentially I refit the
model for different values (not just 10) and saw which one fit the data
best (which one had the highest marginal likelihood). Here is an example
of how this can be done. What you will notice is that essentially the
model tells us that you just want a really big value of sigma. Why? This
actually corresponds to a situation where the multinomial alone is
enough to explain the variation between technical replicates. This
happens occasionally. We also see that the log marginal likelihood
pretty much assemptotes around 10. So rather than picking 100000, I just
settled for 10 as this would be both more numerically stable and just
seemed more reasonable. The model basically just says: “don’t choose a
value less than 10”.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">10</span>, <span class="fl">100</span>, <span class="fl">1000</span><span class="op">)</span> <span class="co"># candidate values</span></span>
<span></span>
<span><span class="va">lml</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span><span class="op">)</span> <span class="co"># log marginal likelihood</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pibble_fit.html">pibble</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>, X<span class="op">=</span><span class="va">X</span>, Gamma <span class="op">=</span> <span class="va">sigma</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">lml</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">logMarginalLikelihood</span> <span class="co"># this is calculated automatically by fido</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sigma</span>, <span class="va">lml</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://github.com/jsilve24/fido/raw/master/vignettes/pcr-max-lik.png" width="50%" style="display: block; margin: auto;"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.justin-silverman.com/" class="external-link">Justin Silverman</a>, Michelle Nixon.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
