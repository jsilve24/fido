<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Example of using Fido for measuring and mitigating PCR Bias • fido</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Example of using Fido for measuring and mitigating PCR Bias">
<meta property="og:description" content="fido">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fido</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.13</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="https://github.com/jsilve24/fido/wiki/Installation-Details">Installation</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction-to-fido.html">Intro to fido through fido::pibble</a>
    </li>
    <li>
      <a href="../articles/non-linear-models.html">Non-Linear Modeling with fido::basset</a>
    </li>
    <li>
      <a href="../articles/orthus.html">Joint Modeling  (e.g., Multiomics) with fido::Orthus</a>
    </li>
    <li>
      <a href="../articles/picking_priors.html">Tips on Specifying Priors</a>
    </li>
    <li>
      <a href="../articles/mitigating-pcrbias.html">Mitigating PCR Bias</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://github.com/jsilve24/RcppCoDA">RcppCoDA</a>
    </li>
    <li>
      <a href="https://jsilve24.github.io/driver/">driver</a>
    </li>
    <li>
      <a href="https://bioconductor.org/packages/release/bioc/html/philr.html">philr</a>
    </li>
    <li>
      <a href="https://cran.r-project.org/package=RcppHungarian">RcppHungarian</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/inschool4life">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/jsilve24/fido">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="mitigating-pcrbias_files/header-attrs-2.3/header-attrs.js"></script><script src="mitigating-pcrbias_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Example of using Fido for measuring and mitigating PCR Bias</h1>
            
      
      
      <div class="hidden name"><code>mitigating-pcrbias.Rmd</code></div>

    </div>

    
    
<p>If you have no already done so, I would read through our manuscript <a href="https://www.biorxiv.org/content/10.1101/604025v1">Measuring and Mitigating PCR Bias in Microbiome Data</a>. This vignette only discusses the computational aspect of our approach, equally important is the design of the PCR calibration curve which is detailed in the manuscript.</p>
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>PCR bias can be both measured and corrected by combining a specially designed calibration curve with statistical models. The below figure gives a brief overview of the calibration experiment. In brief, samples are pooled to create a “calibration sample”. This calibration sample then contains DNA from every taxa in your study. The calibration sample is then split into multiple aliquots and amplified for a varying number of cycles. You then sequence the resulting samples along with the original samples. Then you turn to modeling (which is the focus of this vignette).</p>
<div style="text-align:center">
<p><img src="pcrbias_summary_graphic.png" style="width:50.0%"></p>
</div>
<p>In the manuscript, we show that PCR bias is well approximated by a simple multiplicative process. When translated to sequence count data, this means that PCR bias represents a linear process in log-ratio space: We just need multinomial logistic-normal linear models (aka <code>pibble</code> models in the <em>fido</em> package). If we set our model up correctly then PCR bias is just a linear model: There is a bias parameter and the amout of bias seen for a given sample is that parameter times the number of PCR cycles that sample underwent prior to sequencing. In this case our estimate for the unbiased composition of each sample just becomes a unique intercept for each sample (if you have technical / biological replicates then the replicates will share an intercept; we demonstrate that below as well). Another way to think about this is we want to estimate the composition when the nubmer of PCR cycles is equal to zero (aka the intercept).</p>
</div>
<div id="an-example" class="section level1">
<h1 class="hasAnchor">
<a href="#an-example" class="anchor"></a>An Example</h1>
<p>Here I will show an example of how such data (including calibration samples can be modeled). This is the mock community data we analyzed in the manuscript.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">fido</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">driver</span>)

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">5903</span>)
<span class="co"># First load the data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">pcrbias_mock</span>)</pre></body></html></div>
<p>Lets first take a brief look at the data. There are two objects <code>Y</code> (a count table that I already preprocessed just as in our manuscript) and <code>metadata</code> which containes the covariates we need (including the number of PCR cycles each sample has undergone).</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">Y</span>[<span class="fl">1</span>:<span class="fl">5</span>,<span class="fl">1</span>:<span class="fl">5</span>]
<span class="co">#&gt;               cycle13.1 cycle13.2 cycle13.3 cycle14.1 cycle14.2</span>
<span class="co">#&gt; B.longum             27        28        22        37        44</span>
<span class="co">#&gt; B.subtilis          320       299       272       513       650</span>
<span class="co">#&gt; C.aerofaciens        35        32        39        43        84</span>
<span class="co">#&gt; C.hathewayi          61        52        59        93       117</span>
<span class="co">#&gt; C.innocuum          121        91       112       197       208</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">metadata</span>)
<span class="co">#&gt;   sample_name  sample_num cycle_num machine</span>
<span class="co">#&gt; 1   cycle13.1 Calibration        13       3</span>
<span class="co">#&gt; 2   cycle13.2 Calibration        13       3</span>
<span class="co">#&gt; 3   cycle13.3 Calibration        13       3</span>
<span class="co">#&gt; 4   cycle14.1 Calibration        14       4</span>
<span class="co">#&gt; 5   cycle14.2 Calibration        14       4</span>
<span class="co">#&gt; 6   cycle14.3 Calibration        14       4</span></pre></body></html></div>
<p>The only non-obvious variable here is probably <code>machine</code> which just is a categorical variable denoting which of 4 different PCR machines used to amplify a given sample. When writing the paper, we thought this might be a source of bias so we included this as a term in our model (we will do the same here just to demonstrate how).</p>
<p>As <em>fido</em> doesn’t yet have a formula interface (I will write that eventually), you just need to use the formula interface provided by base-R’s <code>model.matrix</code> function.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span>(~ <span class="no">cycle_num</span> + <span class="no">sample_num</span> + <span class="no">machine</span>  -<span class="fl">1</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">metadata</span>))
<span class="no">X</span>[,<span class="fl">1</span>:<span class="fl">5</span>]
<span class="co">#&gt;                        1  2  3  4  5</span>
<span class="co">#&gt; cycle_num             13 13 13 14 14</span>
<span class="co">#&gt; sample_numCalibration  1  1  1  1  1</span>
<span class="co">#&gt; sample_numMock1        0  0  0  0  0</span>
<span class="co">#&gt; sample_numMock10       0  0  0  0  0</span>
<span class="co">#&gt; sample_numMock2        0  0  0  0  0</span>
<span class="co">#&gt; sample_numMock3        0  0  0  0  0</span>
<span class="co">#&gt; sample_numMock4        0  0  0  0  0</span>
<span class="co">#&gt; sample_numMock5        0  0  0  0  0</span>
<span class="co">#&gt; sample_numMock6        0  0  0  0  0</span>
<span class="co">#&gt; sample_numMock7        0  0  0  0  0</span>
<span class="co">#&gt; sample_numMock8        0  0  0  0  0</span>
<span class="co">#&gt; sample_numMock9        0  0  0  0  0</span>
<span class="co">#&gt; machine2               0  0  0  0  0</span>
<span class="co">#&gt; machine3               1  1  1  0  0</span>
<span class="co">#&gt; machine4               0  0  0  1  1</span></pre></body></html></div>
<p>You can see that in doing this we have created a design matrix which has encoded the PCR machine using a series of 3 dummy variables. We also have a series of dummy variables denoting which samples are biologically unique (e.g., <code>sample_num</code>). The <code>-1</code> in the formula just tells R to have a unique intercept for each biological sample (e.g., to use a one-hot-encoding rather than the dummy encoding used for the PCR machines).</p>
<p>Next we are going to specify our model priors and fit the model. A detailed description of the general thought process I like to follow when creating priors in <em>fido</em> is provided in the vignette <em>Tips for Specifying Priors</em>. Here I am just going to a simple prior where I just change <code>Gamma</code> from its default values. If you are wondering, in the manuscript I choose the multiplier 10 based on maximum marginal likelihood. At the end of this vignette I will show an example of how this can be done.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/pibble_fit.html">pibble</a></span>(<span class="kw">Y</span> <span class="kw">=</span> <span class="no">Y</span>, <span class="kw">X</span><span class="kw">=</span><span class="no">X</span>, <span class="kw">Gamma</span> <span class="kw">=</span> <span class="fl">10</span>*<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">X</span>)))</pre></body></html></div>
<p>Next we are going to transform the results into CLR coordinates and interpret them in that space.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/fido_transforms.html">to_clr</a></span>(<span class="no">fit</span>)</pre></body></html></div>
<p>Thats about it. Now its just interpteting the model results. Lets say you want to investigate the estiamted unbiased composition, then you just have to look at the infered random intercepts for the corresponding <code>sample_num</code> variable. We can plot the results simply enough:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="co"># pull out indicies for random intercepts corresponding to `sample_num`</span>
<span class="no">focus.covariate</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">X</span>)[<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"sample_num"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">X</span>)))]

<span class="co"># Also just so the plot fits nicely in Rmarkdown we are also going to just </span>
<span class="co"># plot a few of the taxa</span>
<span class="no">focus.coord</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"clr_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"S.gallolyticus"</span>, <span class="st">"R.intestinalis"</span>, <span class="st">"L.ruminis"</span>))

<span class="co"># Also to make the plot fit nicely, I just flip the orientation of the plot </span>
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">fit</span>, <span class="kw">par</span><span class="kw">=</span><span class="st">"Lambda"</span>, <span class="kw">focus.cov</span><span class="kw">=</span><span class="no">focus.covariate</span>, <span class="kw">focus.coord</span><span class="kw">=</span><span class="no">focus.coord</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">strip.text.y</span><span class="kw">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">hjust</span><span class="kw">=</span><span class="fl">1</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="no">.data</span>$<span class="no">covariate</span>~<span class="no">.</span>)
<span class="co">#&gt; Warning: 'geom_intervalh' is deprecated.</span>
<span class="co">#&gt; Use 'geom_interval' instead.</span>
<span class="co">#&gt; See help("Deprecated") and help("tidybayes-deprecated").</span></pre></body></html></div>
<p><img src="mitigating-pcrbias_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>The compositional bias introduced at each cycle can also be visualized.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># Also to make the plot fit nicely, I just flip the orientation of the plot </span>
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">fit</span>, <span class="kw">par</span><span class="kw">=</span><span class="st">"Lambda"</span>, <span class="kw">focus.cov</span><span class="kw">=</span><span class="st">"cycle_num"</span>)
<span class="co">#&gt; Warning: 'geom_intervalh' is deprecated.</span>
<span class="co">#&gt; Use 'geom_interval' instead.</span>
<span class="co">#&gt; See help("Deprecated") and help("tidybayes-deprecated").</span></pre></body></html></div>
<p><img src="mitigating-pcrbias_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>The <em>fido</em> package has a bunch of tools for working with such fitted models depending on what you ultimately want to do. See the main <code>pibble</code> vignette for a fuller description of what you can do with such fitted models.</p>
<p>One plot I find particularly useful, is visualizing the calibration data and the fitted bias model. This can be done as follows:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r">
<span class="co"># First transform the data into CLR coordinates (requires pseudo-count to deal with</span>
<span class="co"># zeros). Then will convert to tidy format for ggplot </span>
<span class="no">tidy_calibration</span> <span class="kw">&lt;-</span> <span class="kw pkg">driver</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/driver/man/array_lr_transforms.html">clr_array</a></span>(<span class="no">Y</span>+<span class="fl">0.5</span>, <span class="fl">1</span>) <span class="kw">%&gt;%</span> <span class="co"># transform to CLR</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">starts_with</a></span>(<span class="st">"cycle"</span>)) <span class="kw">%&gt;%</span>  <span class="co"># select only samples from the calibration</span>
  <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>()
<span class="no">tidy_calibration</span>$<span class="no">sample_name</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">tidy_calibration</span>)
<span class="no">tidy_calibration</span> <span class="kw">&lt;-</span> <span class="no">tidy_calibration</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span>(<span class="no">coord</span>, <span class="no">val</span>, -<span class="no">sample_name</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">coord</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">coord</span>, <span class="fl">2</span>, <span class="fl">4</span>))) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span>(<span class="no">metadata</span>, <span class="kw">by</span><span class="kw">=</span><span class="st">"sample_name"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">coord</span> <span class="kw">=</span> <span class="fu"><a href="../reference/name_dims.html">names_coords</a></span>(<span class="no">fit</span>)[<span class="no">coord</span>])


<span class="co"># Now the important part - lets grab the pibble result of interest</span>
<span class="no">X.tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">X</span>), <span class="fl">2</span>) <span class="co"># Create fake covariate data to predict the regression line based on </span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">X.tmp</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">X</span>)
<span class="no">X.tmp</span>[<span class="st">"cycle_num"</span>,<span class="fl">2</span>] <span class="kw">&lt;-</span> <span class="fl">35</span>
<span class="no">X.tmp</span>[<span class="st">"sample_numCalibration"</span>,] <span class="kw">&lt;-</span> <span class="fl">1</span>
<span class="no">X.tmp</span> <span class="co"># simple, just going to predict the composition for each of these two samples</span>
<span class="co">#&gt;                       [,1] [,2]</span>
<span class="co">#&gt; cycle_num                0   35</span>
<span class="co">#&gt; sample_numCalibration    1    1</span>
<span class="co">#&gt; sample_numMock1          0    0</span>
<span class="co">#&gt; sample_numMock10         0    0</span>
<span class="co">#&gt; sample_numMock2          0    0</span>
<span class="co">#&gt; sample_numMock3          0    0</span>
<span class="co">#&gt; sample_numMock4          0    0</span>
<span class="co">#&gt; sample_numMock5          0    0</span>
<span class="co">#&gt; sample_numMock6          0    0</span>
<span class="co">#&gt; sample_numMock7          0    0</span>
<span class="co">#&gt; sample_numMock8          0    0</span>
<span class="co">#&gt; sample_numMock9          0    0</span>
<span class="co">#&gt; machine2                 0    0</span>
<span class="co">#&gt; machine3                 0    0</span>
<span class="co">#&gt; machine4                 0    0</span>
      <span class="co"># for the plot</span>

<span class="co"># Now predict the fitted regression line for cycle_num using X.tmp</span>
<span class="no">predicted</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">fit</span>, <span class="kw">newdata</span><span class="kw">=</span><span class="no">X.tmp</span>, <span class="kw">summary</span><span class="kw">=</span><span class="fl">TRUE</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">cycle_num</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">35</span>)[<span class="no">sample</span>])

<span class="co"># now plot </span>
<span class="no">predicted</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span><span class="kw">=</span><span class="no">cycle_num</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">ymin</span><span class="kw">=</span><span class="no">p2.5</span>, <span class="kw">ymax</span><span class="kw">=</span><span class="no">p97.5</span>), <span class="kw">fill</span><span class="kw">=</span><span class="st">"darkgrey"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span><span class="kw">=</span><span class="no">mean</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">data</span><span class="kw">=</span><span class="no">tidy_calibration</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span><span class="kw">=</span><span class="no">val</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="no">coord</span>~<span class="no">.</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">strip.text.y</span><span class="kw">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span><span class="kw">=</span><span class="fl">0</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"CLR Coordinates"</span>)</pre></body></html></div>
<p><img src="mitigating-pcrbias_files/figure-html/unnamed-chunk-8-1.png" width="576"> There are two things I look for in these plots. First, the data shoudl look linear in this space. If the data does not look linear then there are a few options: (a) something went wrong in your calibration experiment, (b) something is wrong with your code for plotting the calibration data, (c) our theory and prior experiments are wrong and PCR bias is not well approximated as log-ratio linear. Second, you should look to make sure your model is doing a good job fitting the data. Just remember the data here has a<br>
few other sources of variation that the model is accounting for but not plotting. For example, there is batch variation (think about the PCR machine varible we included above). There are also zeros; here we just add a pseudo-count and tranform the data, internally <em>fido</em> is acctually modeling the zeros which should be more appropriate than the pseudo-count.</p>
</div>
<div id="using-maximum-marginal-likelihood-to-estimate-a-scale-of-gamma" class="section level1">
<h1 class="hasAnchor">
<a href="#using-maximum-marginal-likelihood-to-estimate-a-scale-of-gamma" class="anchor"></a>Using Maximum Marginal Likelihood to estimate a scale of Gamma</h1>
<p>Above I chose my prior for gamma to be a diagonal matrix multiplied by a factor of 10. How did I choose 10? In the manuscript I used something called maximum marginal likelihood. Esentially I refit the model for different values (not just 10) and saw which one fit the data best (which one had the highest marginal likelhood). Here is an example of how this can be done. What you will notice is that essentially the model tells us that you just want a really big value of sigma. Why? This acctually corresponds to a situation where the multinomial alone is enough to explain the variation between technical replicates. This happens occasionally. We also see that the log marginal likelihood pretty much assemptotes around 10. So rather than picking 100000, I just settled for 10 as this would be both more numerically stable and just seemed more reasonable. The model basically just says: “don’t choose a value less than 10”.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">sigma</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">10</span>, <span class="fl">100</span>, <span class="fl">1000</span>) <span class="co"># candidate values</span>

<span class="no">lml</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">sigma</span>)) <span class="co"># log marginal likelihood</span>
<span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(<span class="no">sigma</span>)){
  <span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/pibble_fit.html">pibble</a></span>(<span class="kw">Y</span><span class="kw">=</span><span class="no">Y</span>, <span class="kw">X</span><span class="kw">=</span><span class="no">X</span>, <span class="kw">Gamma</span> <span class="kw">=</span> <span class="no">sigma</span>[<span class="no">i</span>]*<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">X</span>)))
  <span class="no">lml</span>[<span class="no">i</span>] <span class="kw">&lt;-</span> <span class="no">fit</span>$<span class="no">logMarginalLikelihood</span> <span class="co"># this is calculated automatically by fido</span>
}
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">sigma</span>, <span class="no">lml</span>)</pre></body></html></div>
<p><img src="mitigating-pcrbias_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Justin Silverman.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
